<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CSV Card Viewer</title>
<link href="bccg_tools.css" rel="stylesheet">
<link href="/bccg_tools.css" rel="stylesheet">
<script src=" https://cdn.jsdelivr.net/npm/papaparse@5.5.3/papaparse.min.js "></script>
<style>
</style>
</head>
<body class="app" id="app">
<table id="step1" style="width:60%;">
<tr><td colspan="2"><strong>Final CSV Card Viewer</strong></td></tr>
<tr><td colspan="2">Step 1: Add CSV input file and upload it.</td></tr>
<tr>
  <td colspan="1"><label>Final CSV File: </label><input type="file" id="final-input" /></td>
  <td colspan="1" style="text-align:right;"><input type="button" id="clicky" value="Process Data"/></td>
</tr>
</table>
<table id="step2" style="visibility:hidden;width:60%; ">
<tr><td colspan=2><label>Step 2: Display Pack#:</label>
  <input type="number" id="sheet-number" value="1" size=2/>
  <input type="button" id="prev" value="< Prev"/>
  <input type="button" id="next" value="Next >"/>
</td>
<td style="text-align:right"><input type="button" id="restart" value="Restart"/></td>
</table>
<div id="card_stats" style="white-space:nowrap;overflow:auto;width:98%;"></div>
<script>
  var card_sheets = []

  document.getElementById("restart").addEventListener("click", function (event) { 
    document.getElementById("card_stats").innerHTML = '';
    document.getElementById("sheet-number").value = 1  
    document.getElementById("step1").style.visibility = 'visible'
    document.getElementById("step1").style.display = ''
    document.getElementById("step2").style.visibility = 'hidden'
    document.getElementById("step2").style.display = 'none'
  });
  document.getElementById("prev").addEventListener("click", function (event) { 
    document.getElementById("sheet-number").value = (document.getElementById("sheet-number").value * 1) - 1
    if (document.getElementById("sheet-number").value < 1) {
      document.getElementById("sheet-number").value = 1  
    }
    cardSheetVisualize( document.getElementById("sheet-number").value * 1)
  });
  document.getElementById("next").addEventListener("click", function (event) { 
    document.getElementById("sheet-number").value = (document.getElementById("sheet-number").value * 1) + 1
    if (document.getElementById("sheet-number").value > card_sheets.length) {
      document.getElementById("sheet-number").value = card_sheets.length
    }
    cardSheetVisualize( document.getElementById("sheet-number").value * 1)
  });
  document.getElementById("clicky").addEventListener("click", function (event) { 
    document.getElementById("sheet-number").value = 1  
    parseFiles(event) 
    document.getElementById("step1").style.visibility = 'hidden'
    document.getElementById("step1").style.display = 'none'
    document.getElementById("step2").style.visibility = 'visible'
    document.getElementById("step2").style.display = ''
  });
  document.getElementById("sheet-number").addEventListener("focusout", function (event) { 
    cardSheetVisualize( document.getElementById("sheet-number").value * 1)
  })
  document.getElementById("sheet-number").addEventListener("change", function (event) { 
    cardSheetVisualize(document.getElementById("sheet-number").value * 1)
  })

  /* Resets the global vars */
  function resetData() {
    card_sheets = []
  }

  /* Main method */
  function parseFiles(ev) {
    resetData();
    let file1 = document.getElementById("final-input").files[0]

    Papa.parse(file1, {
      header: true,
      complete: function (results) {
        console.log(results.meta)
        results.data.forEach((row) => {
          cardVisualize(row)
        })
        cardSheetVisualize(document.getElementById("sheet-number").value * 1)
      }      
    })
  }


  function cardVisualize(row) {
// C:\RogueSignal\089-I-E.jpg

    let card_columns = []
    let card_row = []
    Object.keys(row).forEach((c) => {
      if (/\@CARD/.test(c)) {
        card_columns.push(c)
      }
    })

    card_columns.forEach((ccol) => {
      card = row[ccol]
      // if (card != undefined) {
         card_row.push(card)
      // } 
    })
    card_sheets.push(card_row)
  }

  function cardSheetVisualize(sheet) {
    let card_row = card_sheets[sheet-1]

    document.getElementById("card_stats").innerHTML = '';
    document.getElementById("card_stats").insertAdjacentHTML('beforeend',`<strong>Page #${sheet}: </strong><br>`);
    let i = 0; let k = 0;

    card_row.forEach((card) => {
      let id = card.match(/(\d*)\-\w*\-\w/).pop()
      let type = card.match(/\d*\-(\w*)\-\w/).pop()
      let rarity = card.match(/\d*\-\w*\-(\w)/).pop()
      document.getElementById("card_stats").insertAdjacentHTML('beforeend',
      `<img src="https://explorer.bitcoin-ccg.roguesignal.io/card_image/${id}" style="border:solid 1px #000000;width:220px;min-width:220px;margin:3px;" alt="${card}">`); 
      i++;
      k++;
      if (i == 6) {
        document.getElementById("card_stats").insertAdjacentHTML('beforeend','<br>')
        i = 0
      }
      if (k == 18) {
        document.getElementById("card_stats").insertAdjacentHTML('beforeend','<hr>')
        k = 0
      }
    })
    document.getElementById("card_stats").insertAdjacentHTML('beforeend','<hr>')
  }

// snakeToLabel(key), value: value }));
  function snakeToLabel(str) {
    return str
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  }

  function roundy(num,precision) {
    let multi = Math.pow(10, precision); 
    return (Math.round(num * multi) / multi)
  }
</script>
</body>
</html>

